{% extends "../layouts/candidate-base.html" %}
{% load static %}

{% block title %} Edit Candidate Profile {% endblock %}

{% block stylesheets %}

<style>
    
    .cropper-view-box {
        border-radius: 60%;
    }
    .cropper-face {
        background-color:inherit !important;
    }

    #profile-image {
        margin-top: 10%;
        height: auto;
        width: 80%;
        clip-path: circle();
    }

    #profile-image-input {
        padding: 6%;
    }

  
    .cropper-buttons {
        position: absolute;
        left: 10px;
        width: 70px;
        z-index: 9999;
        font-size: 40px;
        color: white;
        background-color: green;
    }






/* DELETE BUTTON */
    .button {
        --background: red;
        --background-hover: #BA0021;
        --text: #fff;
        --shadow: rgba(0, 9, 61, .2);
        --paper: #5C86FF;
        --paper-lines: #fff;
        --trash: #E1E6F9;
        --trash-lines: #BBC1E1;
        --check: #fff;
        --check-background: #5C86FF;
        position: relative;
        border: none;
        outline: none;
        background: none;
        padding: 15px 24px;
        border-radius: 7px;
        min-width: 142px;
        -webkit-appearance: none;
        -webkit-tap-highlight-color: transparent;
        cursor: pointer;
        display: flex;
        color: var(--text);
        background: var(--btn, var(--background));
        box-shadow: 0 var(--shadow-y, 4px) var(--shadow-blur, 8px) var(--shadow);
        transform: scale(var(--scale, 1));
        transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
        margin-top: 30px;
        margin-bottom: 30px;
    }


    .button span {
        display: block;
        font-size: 1.2rem;
        line-height: 25px;
        font-weight: 600;
        opacity: var(--span-opacity, 1);
        transform: translateX(var(--span-x, 0)) translateZ(0);
        transition: transform 0.4s ease var(--span-delay, 0.2s), opacity 0.3s ease var(--span-delay, 0.2s);
    }
    .button .trash {
        display: block;
        position: relative;
        left: -8px;
        transform: translate(var(--trash-x, 0), var(--trash-y, 1px)) translateZ(0) scale(var(--trash-scale, 0.64));
        transition: transform 0.5s;
    }
    .button .trash:before, .button .trash:after {
        content: "";
        position: absolute;
        height: 8px;
        width: 2px;
        border-radius: 1px;
        background: var(--icon, var(--trash));
        bottom: 100%;
        transform-origin: 50% 6px;
        transform: translate(var(--x, 3px), 2px) scaleY(var(--sy, 0.7)) rotate(var(--r, 0deg));
        transition: transform 0.4s, background 0.3s;
    }
    .button .trash:before {
        left: 1px;
    }
    .button .trash:after {
        right: 1px;
        --x: -3px;
    }
    .button .trash .top {
        position: absolute;
        overflow: hidden;
        left: -4px;
        right: -4px;
        bottom: 100%;
        height: 40px;
        z-index: 1;
        transform: translateY(2px);
    }
    .button .trash .top:before, .button .trash .top:after {
        content: "";
        position: absolute;
        border-radius: 1px;
        background: var(--icon, var(--trash));
        width: var(--w, 12px);
        height: var(--h, 2px);
        left: var(--l, 8px);
        bottom: var(--b, 5px);
        transition: background 0.3s, transform 0.4s;
    }
    .button .trash .top:after {
        --w: 28px;
        --h: 2px;
        --l: 0;
        --b: 0;
        transform: scaleX(var(--trash-line-scale, 1));
    }
    .button .trash .top .paper {
        width: 14px;
        height: 18px;
        background: var(--paper);
        left: 7px;
        bottom: 0;
        border-radius: 1px;
        position: absolute;
        transform: translateY(-16px);
        opacity: 0;
    }
    .button .trash .top .paper:before, .button .trash .top .paper:after {
        content: "";
        width: var(--w, 10px);
        height: 2px;
        border-radius: 1px;
        position: absolute;
        left: 2px;
        top: var(--t, 2px);
        background: var(--paper-lines);
        transform: scaleY(0.7);
        box-shadow: 0 9px 0 var(--paper-lines);
    }
    .button .trash .top .paper:after {
        --t: 5px;
        --w: 7px;
    }
    .button .trash .box {
        width: 20px;
        height: 25px;
        border: 2px solid var(--icon, var(--trash));
        border-radius: 1px 1px 4px 4px;
        position: relative;
        overflow: hidden;
        z-index: 2;
        transition: border-color 0.3s;
    }
    .button .trash .box:before, .button .trash .box:after {
        content: "";
        position: absolute;
        width: 4px;
        height: var(--h, 20px);
        top: 0;
        left: var(--l, 50%);
        background: var(--b, var(--trash-lines));
    }
    .button .trash .box:before {
        border-radius: 2px;
        margin-left: -2px;
        transform: translateX(-3px) scale(0.6);
        box-shadow: 10px 0 0 var(--trash-lines);
        opacity: var(--trash-lines-opacity, 1);
        transition: transform 0.4s, opacity 0.4s;
    }
    .button .trash .box:after {
        --h: 16px;
        --b: var(--paper);
        --l: 1px;
        transform: translate(-0.5px, -16px) scaleX(0.5);
        box-shadow: 7px 0 0 var(--paper), 14px 0 0 var(--paper), 21px 0 0 var(--paper);
    }
    .button .trash .check {
        padding: 4px 3px;
        border-radius: 50%;
        background: var(--check-background);
        position: absolute;
        left: 2px;
        top: 24px;
        opacity: var(--check-opacity, 0);
        transform: translateY(var(--check-y, 0)) scale(var(--check-scale, 0.2));
        transition: transform var(--check-duration, 0.2s) ease var(--check-delay, 0s), opacity var(--check-duration-opacity, 0.2s) ease var(--check-delay, 0s);
    }
    .button .trash .check svg {
        width: 8px;
        height: 6px;
        display: block;
        fill: none;
        stroke-width: 1.5;
        stroke-dasharray: 9px;
        stroke-dashoffset: var(--check-offset, 9px);
        stroke-linecap: round;
        stroke-linejoin: round;
        stroke: var(--check);
        transition: stroke-dashoffset 0.4s ease var(--checkmark-delay, 0.4s);
    }
    .button.delete {
        --span-opacity: 0;
        --span-x: 16px;
        --span-delay: 0s;
        --trash-x: 80px;
        --trash-y: 2px;
        --trash-scale: 1;
        --trash-lines-opacity: 0;
        --trash-line-scale: 0;
        --icon: #fff;
        --check-offset: 0;
        --check-opacity: 1;
        --check-scale: 1;
        --check-y: 16px;
        --check-delay: 1.7s;
        --checkmark-delay: 2.1s;
        --check-duration: .55s;
        --check-duration-opacity: .3s;
    }
    .button.delete .trash:before, .button.delete .trash:after {
        --sy: 1;
        --x: 0;
    }
    .button.delete .trash:before {
        --r: 40deg;
    }
    .button.delete .trash:after {
        --r: -40deg;
    }
    .button.delete .trash .top .paper {
        -webkit-animation: paper 1.5s linear forwards 0.5s;
                animation: paper 1.5s linear forwards 0.5s;
    }
    .button.delete .trash .box:after {
        -webkit-animation: cut 1.5s linear forwards 0.5s;
                animation: cut 1.5s linear forwards 0.5s;
    }
    .button:not([disabled]).button.delete, 
    .button:not([disabled]).button:hover {
        --btn: var(--background-hover);
        --shadow-y: 5px;
        --shadow-blur: 9px;
    }
    .button:not([disabled]).button:active {
        --shadow-y: 2px;
        --shadow-blur: 5px;
        --scale: .94;
    }


    .button:disabled {
        opacity: 0.5;
        cursor: auto;
    }


    @-webkit-keyframes paper {
        10%, 100% {
            opacity: 1;
        }
        20% {
            transform: translateY(-16px);
        }
        40% {
            transform: translateY(0);
        }
        70%, 100% {
            transform: translateY(24px);
        }
    }

    @keyframes paper {
        10%, 100% {
            opacity: 1;
        }
        20% {
            transform: translateY(-16px);
        }
        40% {
            transform: translateY(0);
        }
        70%, 100% {
            transform: translateY(24px);
        }
        }
        @-webkit-keyframes cut {
        0%, 40% {
            transform: translate(-0.5px, -16px) scaleX(0.5);
        }
        100% {
            transform: translate(-0.5px, 24px) scaleX(0.5);
        }
        }
        @keyframes cut {
        0%, 40% {
            transform: translate(-0.5px, -16px) scaleX(0.5);
        }
        100% {
            transform: translate(-0.5px, 24px) scaleX(0.5);
        }
    }
    





/* UPLOAD BUTTON */

/* Turn off completely during animation sequence */
.upload-btn:disabled:not(.loading, .checked) {
    opacity: 0.4;
    cursor: default !important;
}

.upload-btn{
    padding: 0;
	position: relative;
	width: 170px;
	height: 50px;
	line-height: 50px;
	border-radius: 10px;
	border: 3px solid #1ECD97;
	background-color: transparent;
	text-align: center;
	color: #1ECD97;
	font-size: 1.3em;
    font-weight: 600;
	transition: all .3s ease-in;
	-webkit-transition: all .3s ease-in;
	cursor:pointer;
    box-sizing: content-box;
}

.upload-btn.loading{
	width: 50px!important;
	border-radius: 100%;
	border-color: #999;
	background-color: transparent!important;
}

.upload-btn.loading span{
	opacity: 0;
	visibility: hidden;
}

.upload-btn::after {
	content: '';
	position: absolute;
	top: -3px;
	right: -3px;
	height: 28px;
  width: 55px;
	background-color: #1ECD97;
	border-top-left-radius: 55px;
  border-top-right-radius: 55px;
	-webkit-animation: 1s linear infinite rotate;
  animation: 1s linear infinite rotate;
	animation-delay: .5s;
  -webkit-transform-origin: 50% 100%;
	transform-origin: 50% 100%;
	z-index: 9;
	opacity: 0;
}

.upload-btn::before{
	content: '';
	position: absolute;
	top: 0;
	right: 0;
	left: 0;
	bottom: 0;
	z-index: -1;
	background-color: #fff;
	border-radius: 100%;
}

.loading::before{
	z-index: 10;
}

.loading::after,.loading::before{
	opacity: 1;
	transition: opacity .3s ease;
	-webkit-transition: opacity .3s ease;
	transition-delay: .4s;
	-webkit-transition-delay: .4s;
}

@-webkit-keyframes rotate {
  from {
    -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
  }
  to {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}

@keyframes rotate {
  from {
    -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
  }
  to {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}

.checked{
	background-color: #1ECD97!important;
	position: relative;
}

.checked::after{
	content: '';
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%, -50%);
	-webkit-transform: translate(-50%, -50%);
	width: 50px;
	height: 50px;
	background-size: 50px;
	animation: none;
    opacity: 1;
    background-color: transparent;
	background-image: url(data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjEyOHB4IiBoZWlnaHQ9IjEyOHB4Ij4KPGc+Cgk8Zz4KCQk8cGF0aCBkPSJNNTA0LjUwMiw3NS40OTZjLTkuOTk3LTkuOTk4LTI2LjIwNS05Ljk5OC0zNi4yMDQsMEwxNjEuNTk0LDM4Mi4yMDNMNDMuNzAyLDI2NC4zMTFjLTkuOTk3LTkuOTk4LTI2LjIwNS05Ljk5Ny0zNi4yMDQsMCAgICBjLTkuOTk4LDkuOTk3LTkuOTk4LDI2LjIwNSwwLDM2LjIwM2wxMzUuOTk0LDEzNS45OTJjOS45OTQsOS45OTcsMjYuMjE0LDkuOTksMzYuMjA0LDBMNTA0LjUwMiwxMTEuNyAgICBDNTE0LjUsMTAxLjcwMyw1MTQuNDk5LDg1LjQ5NCw1MDQuNTAyLDc1LjQ5NnoiIGZpbGw9IiNGRkZGRkYiLz4KCTwvZz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K);
}

.checked span{
	opacity: 0;
	visibility: hidden;
}

.pxp-text-light{
    font-size: 0.9rem;
}


</style>


<style id="filepond-image-style">
    @media (min-width: 600px) {
        #image-uploader .filepond--item {
            width: calc(50% - 0.5em);
        }
    }
</style>

<style id="filepond-video-style">
        @media (min-width: 600px) {
            #video-uploader .filepond--item {
            width: calc(50% - 0.5em);
        }
    }
</style>

<link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet" />
<link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/filepond-plugin-media-preview@1.0.11/dist/filepond-plugin-media-preview.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.css" integrity="sha512-087vysR/jM0N5cp13Vlp+ZF9wx6tKbvJLwPO8Iit6J7R+n7uIMMjg37dEgexOshDmDITHYY5useeSmfD1MYiQA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nanogallery2/3.0.5/css/nanogallery2.min.css" integrity="sha512-6sOT9zKSKq1CYgNMqtcY84tFPDnG1yX5mxwdGQiAVpAomVr2kUKJ//pFeU/KfaZDVCOru5iFOVswpT4RWWF2dQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<style>

#video-gallery .nGY2GThumbnailImage.nGY2TnImgBack::before {
    color: white;
    content: "\25B8";
    opacity: 0.6;
    position: absolute;
    z-index: 100;
    font-size:200px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}

/* Make the button fade on hover */
#video-gallery .nGY2GThumbnailImage.nGY2TnImgBack:hover::before {
    opacity: 0.4;
} 


</style>

{% endblock stylesheets %}



{% block innercontent %}

            <div class="pxp-dashboard-content-details">
                <h1>Edit Media</h1>
                <p class="pxp-text-light">Add and remove your images and videos.</p>
                

          
            <form id="filepond-form" method="post" enctype="multipart/form-data">

                    {% csrf_token %}
                
                <div class="row">
                    <h4>Edit your profile pic</h4>
                    <div class="col-sm-6" id="profile-image-input">                        
                        <input type="file" class="pond" id="profile-image-uploader" name="profile" />
                    </div>

                    <div class="col-sm-6" id="profile-pic-container">
                        <div class="text-center">
                            
                            <img src="
                            {% if request.user.profile_pic %}
                            {{ request.user.profile_pic.url }}
                            {% endif %}
                            "
                            id="profile-image" alt="profile picture">
                            
                        </div>
                        <div class="text-center">
                            <button type="button" id="delete-profile-pic-btn" class="mt-3 btn btn-danger">Delete Profile Pic</button>
                        </div>
                    </div>
                </div>


                <div class="mt-5 mt-sm-0">
                    <h4 class="mb-0">Add Images</h4>
                    <p class="pxp-text-light">Max 20 images. Max file size: 10MB.</P>
                    <div class="mb-5 col-sm-6 upload-container">
                        <input type="file"
                            id="image-uploader" 
                            class="pond"
                            multiple
                            data-allow-reorder="true"
                    </div>
                </div>
                
                <div class="mt-2">
                    <h4 class="mb-0">Add Videos</h4>
                    <p class="pxp-text-light">Max 10 videos. Max file size: 20MB. Must be .MP4 or .WEBP.</P>
                    <div class="col-sm-6 upload-container" id="video-upload-container" >
                        <input type="file"
                            id="video-uploader" 
                            class="pond"
                            multiple
                            data-allow-reorder="true"    
                    </div>
                </div>


                <button class="upload-btn" class="mt-5" type="submit" disabled>
                    <span>Store Uploads</span>
                    <div class="rotate"></div>
                </button>

            </form>



            <div class="mt-5">

                <h3 id="image-gallery-text">Your Uploaded Photos</h3>
                <div id="image-gallery" data-nanogallery2='{
                    "thumbnailHeight": "auto",
                    "thumbnailWidth": "250 XS400",
                    "thumbnailSelectable": true
                }'>

                {% for img in request.user.candidate.images.all %}
                    <a  href="{{ img.image.url }}" 
                        data-ngthumb="{{ img.image.url }}"
                        data-ngid={{ img.pk }}
                        data-ngcustomData='{ "id":"{{ img.pk }}"}'
                    >
                    </a>
                {% endfor %}
                </div>

                

                
            <h3 class="mt-5" id="video-gallery-text">Your Uploaded Videos:</h3>
            <div id="video-gallery" data-nanogallery2='{
                "thumbnailHeight": "auto",
                "thumbnailWidth": "300 XS400",
                "thumbnailSelectable": true,
                
                "viewerTools":     {
                    "topLeft":    "pageCounter",
                    "topRight":   "fullscreenButton, closeButton"
                  }
            }'>
                {% for vid in request.user.candidate.videos.all %}
                    <a href="{{ vid.video.url }}" 
                        data-ngthumb="{{ vid.thumbnail }}"
                        data-ngid={{ vid.pk }}
                        data-ngcustomData='{ "id":"{{ vid.pk }}"}'
                    >
                    </a>
                {% endfor %}
            </div>


            <button id="delete-button" class="button" disabled>
                <div class="trash">
                    <div class="top">
                        <div class="paper"></div>
                    </div>
                    <div class="box"></div>
                    <div class="check">
                        <svg viewBox="0 0 8 6">
                            <polyline points="1 3.4 2.71428571 5 7 1"></polyline>
                        </svg>
                    </div>
                </div>
                <span>Delete Selected</span>
            </button>
       
                    

            </div>

        </div>

{% endblock innercontent %}








{% block javascript %}

<script src="https://unpkg.com/filepond-plugin-image-transform/dist/filepond-plugin-image-transform.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-edit/dist/filepond-plugin-image-edit.js"></script>
<script src="https://cdn.jsdelivr.net/npm/filepond-plugin-media-preview@1.0.11/dist/filepond-plugin-media-preview.min.js"></script>
<script src="{% static 'js/filepond-plugin-image-size-metadata.js' %}"></script>

<script src="https://unpkg.com/filepond/dist/filepond.min.js"></script>
<script src="https://unpkg.com/jquery-filepond/filepond.jquery.js"></script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js" integrity="sha512-JyCZjCOZoyeQZSd5+YEAcFgz2fowJ1F1hyJOXgtKu4llIa0KneLcidn5bwfutiehUTiOuK87A986BZJMko0eWQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nanogallery2/3.0.5/jquery.nanogallery2.min.js" integrity="sha512-tvpLVnZrWnnNzV2921XEMx4xkFTUF8xg3s+Mi6cvC/R7A6X1FkpBUXPJFa3Xh5uD9BvOZ2tHeYq/5ZqrweW86Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="{% static 'js/cropper.js' %}"></script>


<script>


    $('#video-uploader').on('drop', function(e){
        console.log(e)
    })

const MAX_NUM_IMAGES = 20
const MAX_NUM_VIDEOS = 10


// Prevents `onremovefile` from affecting Store Uploads CSS
let storeBtnBlock = false
let deleteBtnBlock = false


FilePond.registerPlugin(

    FilePondPluginImagePreview,
    FilePondPluginFileValidateType,
    FilePondPluginFileValidateSize,
    FilePondPluginMediaPreview,
    FilepondPluginImageSizeMetadata,
    FilePondPluginImageEdit,
    FilePondPluginImageTransform,
   
);


const uploaded = {};
const uploaded_error = {}; // Currently not using this

FilePond.setOptions({
    
    server: {
        url: '/fp',
        method: 'POST',
        withCredentials: false,


      process: (fieldName, file, metadata, load, error, progress, abort, transfer, options) => {
            // fieldName is the name of the input field
            // file is the actual file object to send

            const imageGalleryCount = $('#image-gallery').nanogallery2('instance').I.reduce((a,x,i) => i && !x.deleted ? ++a : a, 0)
             + $('#image-uploader').filepond('getFiles').length

             if(imageGalleryCount > MAX_NUM_IMAGES){
                return error([403, 'too many uploads', 'image'])
             }

             const videoGalleryCount = $('#video-gallery').nanogallery2('instance').I.reduce((a,x,i) => i && !x.deleted ? ++a : a, 0)
             + $('#video-uploader').filepond('getFiles').length

             if(videoGalleryCount > MAX_NUM_VIDEOS){
                return error([403, 'too many uploads', 'video'])
             }


            const formData = new FormData();
            formData.append(fieldName, file, file.name);

            let upload_field = '';
            
            for (const item of formData.keys()) {
                console.log(item)
                upload_field = item;
                break;
            }
            if (upload_field !== '') {
                formData.append('fp_upload_field',upload_field);
            }


            const request = new XMLHttpRequest();
            request.open('POST', '/fp/process/');

            request.setRequestHeader('X-CSRFToken', '{{ csrf_token }}')


            // Should call the progress method to update the progress to 100% before calling load
            // Setting computable to false switches the loading indicator to infinite mode
            request.upload.onprogress = (e) => {
                progress(e.lengthComputable, e.loaded, e.total);
            };

            // Should call the load method when done and pass the returned server file id
            // this server file id is then used later on when reverting or restoring a file
            // so your server knows which file to return without exposing that info to the client
            request.onload = function () {
                if (request.status >= 200 && request.status < 300) {
                    // the load method accepts either a string (id) or an object
                    load(request.responseText);
                } else {
                    // Can call the error method if something is wrong, should exit after
                    error('oh no');
                }
            };

            request.send(formData);

            // Should expose an abort method so the request can be cancelled
            return {
                abort: () => {
                    // This function is entered if the user has tapped the cancel button
                    request.abort();

                    // Let FilePond know the request has been cancelled
                    abort();
                },
            };
        },

        patch: '/patch/',
        revert: '/revert/',
        fetch: '/fetch/?target=',
        load: '/load/',
        restore: '/restore/',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },

        revert: (src, load) => {
            load();
        },
    },

    // labelFileProcessingError: (error) => {
    //     console.log('LABEL FIRED!')
    //     console.log(error);
    //     return 'My server errored Blah Blah';
    // },

    //    onload: function(src, load) {
    //             console.log('ON LOAD')
    //             console.log(src);

                
    //             // fetch(src)
    //             //     .then(res => res.blob())
    //             //     .then(load)
    //     },    

    onaddfile: function(error, file) {
        console.log(`ONADD ERROR: ${JSON.stringify(error)}`)
        console.log('File added: [' + error + ']   file: [' + file.id + ']');
        if(!error) uploaded[file.id] = 'loading'
        $('.upload-btn').attr('disabled','');
    },

    onprocessfile: function(error, file) {
        console.log('On Process Fired')
        uploaded[file.id] = 'complete'

        if(!storeBtnBlock && checkFinishedLoading(uploaded)){
            $('.upload-btn').attr('disabled','');
        } else {
            $('.upload-btn').removeAttr('disabled');
        }


    },

    onerror: function(error, file) {
        console.log(`ONERROR: ${JSON.parse(JSON.stringify(error))}`)
        error = JSON.parse(JSON.stringify(error))

        if (!error.hasOwnProperty('main')) {
            console.log(error)
            const galleryType = error['2']
            console.log(`GALLERY TYPE: ${galleryType}`)
            const statusText = $(`#filepond--item-${file.id} .filepond--file-status`)[0]
            statusText.children[0].innerText = `Too many ${galleryType}s!`
            statusText.children[1].innerText = `
            Delete ${galleryType}s. The max no of ${galleryType}s is ${galleryType === 'image' ? MAX_NUM_IMAGES : MAX_NUM_VIDEOS}`
        }
        

        console.log('onerror File error: [' + JSON.stringify(error) + ']   file: [' + file.id + '], status [' + JSON.stringify(status) + ']');
        if(file.id in uploaded) {
            delete uploaded[file.id];
        }
        uploaded_error[file.id] = true;	    		
    }
});







const profileImg = FilePond.create(
  document.querySelector('#profile-image-uploader'),{
    labelIdle: `Drag & Drop your profile pic or <span class="filepond--label-action">Browse</span>`,
    imagePreviewHeight: 170,
    stylePanelLayout: 'compact circle',
    styleLoadIndicatorPosition: 'center bottom',
    styleProgressIndicatorPosition: 'right bottom',
    styleButtonRemoveItemPosition: 'left bottom',
    styleButtonProcessItemPosition: 'right bottom',
    credits: false,
    imageEditEditor: editor,

// Error messages not shown for compact circles so just blocked them from adding it
// Can be updated later
    dropValidation: true,
    acceptedFileTypes: ['image/*'],
    fileValidateTypeLabelExpectedTypes: 'Should be an image file like .jpg, .png',


    onaddfile: function(error, file) {
        console.log('File added: [' + error + ']   file: [' + file.id + ']');
        uploaded[file.id] = 'loading'
        $('.upload-btn').attr('disabled','');
    },

    onremovefile: function(error, file) {
        console.log('File removed: [' + error + ']   file: [' + file.id + ']');
        if(file.id in uploaded) delete uploaded[file.id];

    // Manages CSS
        if(!storeBtnBlock && checkFinishedLoading(uploaded)){
            $('.upload-btn').attr('disabled','');
        } else {
            $('.upload-btn').removeAttr('disabled');
        }
        
    },
});





const imagePond = FilePond.create(
  document.querySelector('#image-uploader'),{
    labelIdle: `Drag & Drop your photos or <span class="filepond--label-action">Browse</span>`,
    styleLoadIndicatorPosition: 'center bottom',
    styleProgressIndicatorPosition: 'right bottom',
    styleButtonRemoveItemPosition: 'left bottom',
    styleButtonProcessItemPosition: 'right bottom',
    credits: false,
    // allowMultiple: true,
    // maxFiles: 2,
    name: 'images',
    maxFileSize: '10MB',
    // allowBrowse: true,
    // chunkUploads: true,
    // chunkSize: 50000,
    // allowFileMetadata: false,
    acceptedFileTypes: ['image/*'],
    fileValidateTypeLabelExpectedTypes: 'Should be an image file like .jpg, .png',
    

    onremovefile: function(error, file) {
        console.log('File removed: [' + error + ']   file: [' + file.id + ']');
        if(file.id in uploaded) delete uploaded[file.id];

        
        //Remove rejected files
        imagePond.getFiles().forEach(x => {
            console.log(`STATUS: ${x.status}`)
            if(x.status === 8){
                imagePond.removeFile(x.id)
            }
        })

    // Manages CSS
        if(!storeBtnBlock && checkFinishedLoading(uploaded)){
            $('.upload-btn').attr('disabled','');
        } else {
            $('.upload-btn').removeAttr('disabled');
        }
        
        if(imagePond.getFiles().length <= 1){
            $('#filepond-image-style')[0].disabled = true
            $('.upload-container:has(#image-uploader)').addClass('col-sm-6');
        }
        
    },
});




const videoPond = FilePond.create(
  document.querySelector('#video-uploader'),{
    labelIdle: `Drag & Drop your videos or <span class="filepond--label-action">Browse</span>`,
    styleLoadIndicatorPosition: 'center bottom',
    styleProgressIndicatorPosition: 'right bottom',
    styleButtonRemoveItemPosition: 'left bottom',
    styleButtonProcessItemPosition: 'right bottom',
    credits: false,
    // allowMultiple: true,
    // maxFiles: 2,
    maxFileSize: '20MB',
    name: 'videos',
    allowVideoPreview: true, 
    // allowRevert: false,
    // allowBrowse: true,

    chunkUploads: true,
    chunkSize: 500000,
    allowFileMetadata: false,

    acceptedFileTypes: ['video/mp4', 'video/webm'],
    fileValidateTypeLabelExpectedTypes: 'Should be an .mp4 or .webm file',




    onremovefile: function(error, file) {
        console.log('File removed: [' + error + ']   file: [' + file.id + ']');
        if(file.id in uploaded) delete uploaded[file.id];

        //Remove rejected files
        videoPond.getFiles().forEach(x => {
            console.log(`STATUS: ${x.status}`)
            if(x.status === 8){
                videoPond.removeFile(x.id)
            }
        })

        console.log(checkFinishedLoading(uploaded))
       
        if(!storeBtnBlock && checkFinishedLoading(uploaded)){
            $('.upload-btn').attr('disabled','');
        } else {
            $('.upload-btn').removeAttr('disabled');
        }

        if(videoPond.getFiles().length <= 1){
            console.log('REMOVED FIRED!!')
            // $('#video-uploader .filepond--item').addClass('change-display-width')
            $('#filepond-video-style')[0].disabled = true
            $('.upload-container:has(#video-uploader)').addClass('col-sm-6');
        } 
    },
});



function checkFinishedLoading(obj) {
    // Check if there are any values
    console.log(obj)
    const arr = Object.values(obj)
    //console.log(arr)
    if(!arr.length){
    //If it's empty, then return true
        return true
    } else {
        // Then check if still loading
        return arr.some(x => x === 'loading')
    }
} 



// Next two functions handle the resizing/widening of
// the dropzone area if more than one file added
$(document).ready(()=> {
    $('#filepond-image-style')[0].disabled = true
    $('#filepond-video-style')[0].disabled = true

    if($('#image-gallery').nanogallery2('instance').I.length === 1){
        $('#image-gallery-text').hide()
    }
    if($('#video-gallery').nanogallery2('instance').I.length === 1){
        $('#video-gallery-text').hide()
    }
    if($('#image-gallery').nanogallery2('instance').I.length === 1
    && $('#video-gallery').nanogallery2('instance').I.length === 1)
    {
        $('#delete-button').hide()
    }
})




$('.upload-container').on('drop change', function() {
//New files dont error
//Just get removed immediately and ids still get uploaded by onaddfile
console.log('upload container fired!!!!!11!!!')

//Remove files that have already been rejected
    const { id } = $(this).children()[0]

    console.log($(this).children())

    $(this).children().filepond('getFiles').forEach(x => {
        console.log(`STATUS: ${x.status}`)
    // Remove files that errored out => status 8
        if(x.status === 8){
            console.log(`STATUS11: ${x.id}`)
            delete uploaded[x.id]; 

            if(id === 'image-uploader'){
                imagePond.removeFile(x.id)
            } else {
                videoPond.removeFile(x.id)
            }
            
        }
    }) 


    //Resize container appropriately
    if(id === 'image-uploader'){
        if(imagePond.getFiles().length >= 1){
            $('#filepond-image-style')[0].disabled = false
            $(this).removeClass('col-sm-6');
        }       
    } else {
        if(videoPond.getFiles().length >= 1){
            $('#filepond-video-style')[0].disabled = false
            $(this).removeClass('col-sm-6');
        }
    } 
});






// Store Upload button animation
$('.upload-btn').on('click', function() {

    const ponds = $('.pond').filepond('getFiles');

    // Add extra spin if more than one video added
    const delay = ponds[2].length > 1 ? 6000 : 3500
    
    if(!$(this).hasClass('loading')){
        $(this).addClass('loading');
        const self = this;
        
        setTimeout(function() {
            $(self).removeClass('loading');
            $(self).addClass('checked');
        }, delay);
        
        setTimeout(function() {
            $(self).removeClass('checked');
        }, delay + 1500);

        setTimeout(function() {
        // Disable the button as all media processed
            $('.upload-btn').attr('disabled','');
        // Release block when animation completely finished
            storeBtnBlock = false
        }, delay + 1800);
    }
})




$('#filepond-form').on('submit', function(e) {
    e.preventDefault();

    
    $('#delete-button').attr('disabled','');
    deleteBtnBlock = true
    const formData = new FormData(this)

    $.ajax({
        type: 'POST',
        // url: '/submitForm/',
        url: '/edit-candidate-media/',

        
        data: formData,
        contentType: false,
        processData: false,

        success: function(e){

            const items = [...$('#image-gallery').nanogallery2('instance').I,
                            ...$('#video-gallery').nanogallery2('instance').I]

        // Only enable delete button if some are selected
            if(items.some(x => !x.deleted && x.selected)){
                $('#delete-button').removeAttr('disabled');
            }
            // Release it when server responds
            deleteBtnBlock = false
            
            const { uploads } = e

            for (const id in uploads){

            // Find the item with this serverId
            // Could cause issues if can't find anything and returns `undefined`
                const item = items.find(x => x.serverId === id)
                console.log(item)
                // console.log(`The returned data is: ${uploads[id]}`)

                const [url, dbID] = uploads[id]

               
                item.customData['id'] = dbID
                item.src = `https://s3.ap-east-1.amazonaws.com/candidate-docs-1/${url}`

                // Create arbitrary attribute to be checked if GetID() returns nothing
                if(item.mediaKind === 'img'){
                    // const { width, height } = item.getMetadata().size
                    const { width, height } = item
                    const newHeight = 200 / (width / height)
                    // newItem.thumbSet(item.src, 200, newHeight);
                    item.thumbSet(item.src, width, height);
                    item.mediaMarkup = `<img class="nGY2ViewerMedia" src="${item.src}" alt="" itemprop="contentURL" draggable="false">`
                } else {
                    item.mediaMarkup = `<video controls class="nGY2ViewerMedia"><source src="${item.src}" type="video/mp4" preload="auto">Your browser does not support the video tag (HTML 5).</video>`;
                }

            }
        },

        beforeSend: function(){

            // 0 - profile pic
            // 1 - images
            // 2 - videos
            const ponds = $('.pond').filepond('getFiles');

        // Handle the profile pic
           if(ponds[0].length){
                const { serverId } = ponds[0][0]
                const src = `/fp/restore/?id=${serverId}`
                $('#profile-image')[0].src = src
                $('#profile-pic-container').show()
                $('.pxp-dashboard-side-user-nav-avatar')[0].style.backgroundImage = `url(${src})`
                $('.pxp-user-nav-avatar')[0].style.backgroundImage = `url(${src})`
                profileImg.removeFile()
                console.log('Added Profile Image')
           }
            

           const imageInst = $('#image-gallery').nanogallery2('instance');
        
        // Loop through images in each pond
            ponds[1].forEach(item => {

                const { serverId } = item
                // NGY2Item() instance, title, description, ID, albumID, kind, tags )
                // const newItem= NGY2Item.New(inst, '','',1,'0','album','')
                
                const src = '/fp/restore/?id='  + serverId
                const { width, height } = item.getMetadata().size
                const newHeight = 200 / (width / height)

                const itemId = imageInst.I.length + 1;
                const newItem = NGY2Item.New(imageInst,'','',itemId,'0','image','')

                newItem.serverId = serverId
                newItem.thumbSet(src, 200, newHeight);
                newItem.setMediaURL(src, 'img');
                newItem.addToGOM();
                console.log('Added Image')
            })

            if($('#image-gallery').nanogallery2('instance').I.some((x,i) => i && !x.deleted)){
                $('#image-gallery-text').show()
                $('#delete-button').show()
            }
            

            const videoInst = $('#video-gallery').nanogallery2('instance');

            ponds[2].forEach(item => {

                // Video
                const { serverId, id } = item
                const src = '/fp/restore/?id=' + serverId
                const file = [...$('.filepond--item')].find(x => x.id.endsWith(id))
                // console.log(src)
                const [thumbSrc, thumbHeight] = getVideoThumbnailInfo(file)
                const obj = {}
                obj[serverId] = thumbSrc //'https://candidate-docs-1.s3.ap-east-1.amazonaws.com/Screenshot%202024-08-01%20at%2016.00.42.png'
                formData.append('thumbnails', JSON.stringify(obj))
                const itemId = videoInst.I.length + 1;

            // Build the new gallery item
                const newItem = NGY2Item.New(videoInst,'','',itemId,'0','image','')
                newItem.serverId = serverId 
                newItem.thumbSet(thumbSrc, 300, thumbHeight);
                newItem.setMediaURL(src, 'video');
                newItem.mediaMarkup = `<video controls class="nGY2ViewerMedia"><source src="${src}" type="video/mp4" preload="auto">Your browser does not support the video tag (HTML 5).</video>`;
                newItem.addToGOM();
                console.log(newItem)
                console.log('Added Video')
            })

            if($('#video-gallery').nanogallery2('instance').I.some((x,i) => i && !x.deleted)){
                $('#video-gallery-text').show()
                $('#delete-button').show()
            }

        // Refresh both galleries if necessary
            if(ponds[1].length){
                imagePond.removeFiles()
                $('#image-gallery').nanogallery2('data').gallery.albumIdx = 0
                $('#image-gallery').nanogallery2('refresh')
            }

            if(ponds[2].length){
                videoPond.removeFiles()
                $('#video-gallery').nanogallery2('data').gallery.albumIdx = 0
                $('#video-gallery').nanogallery2('refresh')
            }

        }
    });
});


function getVideoThumbnailInfo(video){

    video = video.children[0].children[1].children[12].children[0].children[0]
    console.log(video)

    // let dpi = window.devicePixelRatio;
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    // ctx.imageSmoothingEnabled = false;

    const w = 300
    const h = (w * video.clientHeight / video.clientWidth)
    canvas.width = w
    canvas.height = h

    ctx.drawImage(video, 0, 0, w, h);
    return [canvas.toDataURL(), h];
}


// Next 2 functions control the display of the uploaded profile pic
$(document).ready(()=> {
    if(location.href === $('#profile-image')[0].src){
        $('#profile-pic-container').hide()
    }
})

$('#delete-profile-pic-btn').on('click', () => {

    $('#profile-pic-container').hide()
    $('.pxp-dashboard-side-user-nav-avatar')[0].style.backgroundImage = 'url("{% static 'images/candidate-default.webp' %}")'
    $('.pxp-user-nav-avatar')[0].style.backgroundImage = 'url("{% static 'images/candidate-default.webp' %}")'

    $.ajax({
        type: 'DELETE',
        url: '/delete-profile-pic/',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        dataType: 'html'
    })
})




// Next three functions handle the DELETE button

function updateDeleteButton(){
    const selected = [...$('#image-gallery').nanogallery2('itemsSelectedGet'),
                     ...$('#video-gallery').nanogallery2('itemsSelectedGet')]

    console.log(selected)

    // Check it's not blocked first
    if(!deleteBtnBlock){
    // If one is NOT deleted, then enable button
        if(selected.some(x => !x.deleted)){
            $('#delete-button').removeAttr('disabled');
        } else {
            $('#delete-button').attr('disabled','');
        }
    }
}


//Enable and disable the delete button
$(document).on('itemSelected.nanogallery2 itemUnSelected.nanogallery2', ()=> {
    console.log('SELECTED FIRED!')
    updateDeleteButton()  
})


// Fired on DELETE items
$('#delete-button').on('click', function(e) {
    e.preventDefault();

    const selected = [...$('#image-gallery').nanogallery2('itemsSelectedGet'),
                     ...$('#video-gallery').nanogallery2('itemsSelectedGet')]

    console.log(selected)

    // End it if nothing selected
    // if(!selected.length) return

    // console.log(this.classList)
    // Part of button animation
    if(!this.classList.contains('delete')) {
        this.classList.add('delete');
        setTimeout(() => this.classList.remove('delete'), 3200);
    }

    // Build the url. A little more complicated as files are not deleted
    // Just their .deleted attribute is changed
    const url = selected.reduce((a,x) => {
        if(!x.deleted){
        // Pull ID from customData
            const { id } = x.customData
            const { mediaKind } = x
            x.deleted = true
            x.selected = false
            return a += `${a ? '&' : '?'}${mediaKind}=${id}`
        }
        return a
    },'')


    $.ajax({
        type: 'DELETE',
        url: `/delete-media/${url}`,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        dataType: 'html',
    });

    setTimeout(() => {  
        if (url.includes('img')){
            $('#image-gallery').nanogallery2('refresh');
            $('#image-gallery').nanogallery2('data').gallery.nbSelected = 0
            if(!$('#image-gallery').nanogallery2('instance').I.some((x,i) => i && !x.deleted)){
                $('#image-gallery-text').hide()
            }
        }
        if (url.includes('video')){
            $('#video-gallery').nanogallery2('refresh')
            $('#video-gallery').nanogallery2('data').gallery.nbSelected = 0
            if(!$('#video-gallery').nanogallery2('instance').I.some((x,i) => i && !x.deleted)){
                $('#video-gallery-text').hide()
            }
        }

        if(!$('#image-gallery').nanogallery2('instance').I.some((x,i) => i && !x.deleted)
        && !$('#video-gallery').nanogallery2('instance').I.some((x,i) => i && !x.deleted))
        {
            $('#delete-button').hide()
        }

    }, 2000);

    updateDeleteButton()
})


</script>

{% endblock javascript %}